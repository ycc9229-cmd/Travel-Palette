<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è‰²ç­†è¨˜ Pro - Travel Palette</title>
    <!-- å¼•å…¥ Tailwind CSS èˆ‡ Lucide åœ–ç¤º -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: #FFFDF0;
            color: #374151;
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å‹•ç•«æ•ˆæœ */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* å°è¦½æŒ‰éˆ•å•Ÿå‹•ç‹€æ…‹ */
        .nav-active {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="pb-36 md:pb-32">

    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <header class="pt-8 md:pt-10 pb-4 md:pb-6 text-center relative max-w-4xl mx-auto flex flex-col items-center px-4">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-[#FF85A1] tracking-tighter drop-shadow-sm">æ—…è‰²ç­†è¨˜</h1>
        <p class="text-[9px] md:text-[10px] text-gray-400 font-bold tracking-[0.3em] md:tracking-[0.4em] mt-1 opacity-60 uppercase">Travel Palette</p>
        <div class="w-10 md:w-12 h-1 md:h-1.5 bg-[#FFD1A4] rounded-full mt-2 opacity-40"></div>
        
        <button class="absolute right-4 md:right-6 top-8 md:top-10 w-9 h-9 md:w-10 md:h-10 bg-white rounded-full shadow-md flex items-center justify-center text-[#FF85A1] border border-gray-100">
            <i data-lucide="user" class="w-4 h-4 md:w-5 md:h-5"></i>
        </button>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="main-content" class="px-4 md:px-6 max-w-4xl mx-auto fade-in">
        <!-- å…§å®¹æœƒç”± JavaScript å‹•æ…‹æ’å…¥ -->
    </main>

    <!-- å›ºå®šæ‡¸æµ®æŒ‰éˆ• (åœ°åœ–) -->
    <button id="floating-map-btn" class="fixed bottom-28 md:bottom-28 right-4 md:right-6 w-12 h-12 md:w-14 md:h-14 bg-[#8EC5FC] text-white rounded-full shadow-xl flex items-center justify-center hover:scale-110 active:scale-90 transition-all z-40 border-4 border-white hidden">
        <i data-lucide="navigation" class="w-6 h-6" fill="currentColor"></i>
    </button>

    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="fixed bottom-4 md:bottom-6 left-1/2 -translate-x-1/2 w-[94%] md:w-full max-w-lg bg-white/95 backdrop-blur-lg rounded-[2rem] md:rounded-[2.5rem] p-1.5 md:p-2 shadow-2xl flex justify-between items-center z-50 border border-white/50">
        <button onclick="switchTab('home')" id="nav-home" class="nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0">
            <i data-lucide="map" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold truncate">é¦–é </span>
        </button>
        <button onclick="switchTab('favorite')" id="nav-favorite" class="nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0">
            <i data-lucide="heart" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold truncate">æ”¶è—</span>
        </button>
        <button onclick="switchTab('itinerary')" id="nav-itinerary" class="nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0">
            <i data-lucide="calendar" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold truncate">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('calorie')" id="nav-calorie" class="nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0">
            <i data-lucide="flame" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold truncate">ç†±é‡</span>
        </button>
        <button onclick="switchTab('journal')" id="nav-journal" class="nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0">
            <i data-lucide="book-open" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold truncate">æ—¥è¨˜</span>
        </button>
        <button onclick="switchTab('checklist')" id="nav-checklist" class="nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0">
            <i data-lucide="check-square" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold truncate">æ¸…å–®</span>
        </button>
    </nav>

    <!-- åœ°å€é¸æ“‡å™¨å½ˆçª— (éš±è—) -->
    <div id="picker-modal" class="fixed inset-0 bg-black/50 backdrop-blur-md z-[100] items-end justify-center hidden">
        <!-- å…§å®¹å‹•æ…‹æ¸²æŸ“ -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, addDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- å…¨åŸŸè®Šæ•¸ ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'travel-palette-final';
        
        let currentUser = null;
        let activeTab = 'home';
        let state = {
            calories: [],
            myItineraries: [],
            sharedItineraries: [],
            journals: [],
            selectedGuide: null,
            showAdventure: true
        };

        // --- èªè­‰æµç¨‹ ---
        const initAuth = async () => {
            try {
                // å„ªå…ˆä½¿ç”¨è‡ªå®šç¾©æ¬Šæ–ç™»å…¥
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("èªè­‰åˆå§‹åŒ–å¤±æ•—:", error);
            }

            // ç›£è½èº«ä»½é©—è­‰ç‹€æ…‹è®Šæ›´
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    setupListeners();
                } else {
                    console.log("ç”¨æˆ¶æœªç™»å…¥æˆ–å·²ç™»å‡º");
                }
            });
        };

        // --- æ•¸æ“šç›£è½ ---
        const setupListeners = () => {
            if (!currentUser) return;

            const errorCallback = (error) => {
                console.error("Firestore ç›£è½éŒ¯èª¤:", error);
            };

            // ç›£è½ç†±é‡æ•¸æ“š
            onSnapshot(
                collection(db, 'artifacts', appId, 'users', currentUser.uid, 'calories'), 
                (snap) => {
                    state.calories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (activeTab === 'calorie') render();
                },
                errorCallback
            );

            // ç›£è½æ—¥è¨˜æ•¸æ“š
            onSnapshot(
                collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals'), 
                (snap) => {
                    state.journals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (activeTab === 'journal') render();
                },
                errorCallback
            );

            // ç›£è½å€‹äººè¡Œç¨‹
            onSnapshot(
                collection(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries'), 
                (snap) => {
                    state.myItineraries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (activeTab === 'itinerary') render();
                },
                errorCallback
            );

            // ç›£è½å…¬å…±å…±äº«è¡Œç¨‹
            onSnapshot(
                collection(db, 'artifacts', appId, 'public', 'data', 'shared_itineraries'), 
                (snap) => {
                    state.sharedItineraries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (activeTab === 'itinerary') render();
                },
                errorCallback
            );
        };

        // --- æ¸²æŸ“å¼•æ“ ---
        window.switchTab = (tab) => {
            activeTab = tab;
            state.selectedGuide = null;
            render();
        };

        window.render = () => {
            const container = document.getElementById('main-content');
            const mapBtn = document.getElementById('floating-map-btn');
            
            // æ›´æ–°å°è¦½åˆ—æ¨£å¼
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = "nav-btn flex flex-col items-center justify-center p-1.5 md:p-2 rounded-xl md:rounded-2xl transition-all flex-1 min-w-0 text-gray-400 hover:bg-gray-50";
            });
            
            const activeBtn = document.getElementById(`nav-${activeTab}`);
            const colors = { home: 'bg-[#8EC5FC]', favorite: 'bg-[#FF85A1]', itinerary: 'bg-[#FFA45B]', calorie: 'bg-[#FFCCF9]', journal: 'bg-[#FFD1A4]', checklist: 'bg-[#B2F9B4]' };
            if (activeBtn) activeBtn.className += ` nav-active ${colors[activeTab]} text-white shadow-lg`;

            // é¡¯ç¤ºåœ°åœ–æŒ‰éˆ•
            if (activeTab === 'home' && !state.selectedGuide) mapBtn.classList.remove('hidden');
            else mapBtn.classList.add('hidden');

            if (state.selectedGuide) {
                container.innerHTML = renderGuideDetail();
            } else {
                switch (activeTab) {
                    case 'home': container.innerHTML = renderHome(); break;
                    case 'calorie': container.innerHTML = renderCalorie(); break;
                    case 'journal': container.innerHTML = renderJournal(); break;
                    case 'itinerary': container.innerHTML = renderItinerary(); break;
                    case 'favorite': container.innerHTML = `<div class="p-10 text-center"><i data-lucide="heart" class="mx-auto text-[#FF85A1] mb-4 opacity-30 w-12 h-12"></i><h3 class="text-lg font-black text-gray-400">æ”¶è—å¤¾</h3></div>`; break;
                    case 'checklist': container.innerHTML = `<div class="p-10 text-center"><i data-lucide="check-square" class="mx-auto text-[#B2F9B4] mb-4 opacity-30 w-12 h-12"></i><h3 class="text-lg font-black text-gray-400">è¡Œææ¸…å–®</h3></div>`; break;
                }
            }
            lucide.createIcons();
        };

        // --- å„è¦–åœ–æ¸²æŸ“å™¨ ---
        const renderHome = () => `
            <div class="space-y-8">
                <section>
                    <h3 class="text-lg font-black flex items-center gap-2 mb-4"><div class="w-2 h-6 bg-[#FF85A1] rounded-full"></div>ç²¾é¸æ¨è–¦</h3>
                    <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar -mx-4 px-4 snap-x">
                        <div class="min-w-[200px] h-64 relative rounded-[2.5rem] overflow-hidden shadow-lg snap-start">
                            <img src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-5 left-5 text-white">
                                <span class="text-[10px] bg-white/20 backdrop-blur-md px-2 py-1 rounded-full uppercase font-bold">è‡ªç„¶</span>
                                <p class="text-xl font-black mt-1">åµå±±ç«¹æ—</p>
                            </div>
                        </div>
                        <div class="min-w-[200px] h-64 relative rounded-[2.5rem] overflow-hidden shadow-lg snap-start">
                            <img src="https://images.unsplash.com/photo-1590559899731-a382839e5549?w=400" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-5 left-5 text-white">
                                <span class="text-[10px] bg-white/20 backdrop-blur-md px-2 py-1 rounded-full uppercase font-bold">ç¾é£Ÿ</span>
                                <p class="text-xl font-black mt-1">é“é “å €</p>
                            </div>
                        </div>
                    </div>
                </section>

                ${state.showAdventure ? `
                <div class="bg-gradient-to-br from-[#8EC5FC] to-[#E0C3FC] p-6 rounded-[2.5rem] text-white shadow-lg relative overflow-hidden">
                    <button onclick="state.showAdventure=false; render()" class="absolute top-4 right-4 p-1 hover:bg-white/20 rounded-full transition-colors z-20"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-black italic">æº–å‚™å¥½å†’éšªäº†å—ï¼Ÿ</h2>
                        <p class="opacity-90 mb-4 text-sm">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¿«é€Ÿå®šä½</p>
                        <button onclick="window.open('https://www.google.com/maps')" class="bg-white text-[#8EC5FC] px-6 py-2 rounded-full font-bold flex items-center gap-2 shadow-lg active:scale-95 transition-all text-sm">
                            <i data-lucide="navigation" class="w-4 h-4" fill="currentColor"></i> å¿«é€Ÿé–‹å•Ÿåœ°åœ–
                        </button>
                    </div>
                    <i data-lucide="map" class="absolute -bottom-4 -right-4 w-24 h-24 opacity-20 transform -rotate-12"></i>
                </div>` : ''}

                <section>
                    <h3 class="text-lg font-black mb-4">æ¢ç´¢éˆæ„Ÿ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div onclick="state.selectedGuide={id:1, title:'äººæ°£æ™¯é»æ’è¡Œ', color:'bg-[#8EC5FC]', img:'ğŸ¯'}; render()" class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-5 cursor-pointer hover:shadow-md border border-gray-50">
                            <div class="w-16 h-16 bg-[#8EC5FC] rounded-2xl flex items-center justify-center text-3xl">ğŸ¯</div>
                            <div class="flex-1">
                                <span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">æ—…éŠ</span>
                                <h4 class="font-black text-lg text-gray-700">äººæ°£æ™¯é»æ’è¡Œ</h4>
                            </div>
                            <i data-lucide="chevron-right" class="text-gray-200"></i>
                        </div>
                        <div onclick="state.selectedGuide={id:2, title:'ç¾é£Ÿåœ°åœ–æ¨è–¦', color:'bg-[#FFCCF9]', img:'ğŸ£'}; render()" class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-5 cursor-pointer hover:shadow-md border border-gray-50">
                            <div class="w-16 h-16 bg-[#FFCCF9] rounded-2xl flex items-center justify-center text-3xl">ğŸ£</div>
                            <div class="flex-1">
                                <span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">ç¾é£Ÿ</span>
                                <h4 class="font-black text-lg text-gray-700">ç¾é£Ÿåœ°åœ–æ¨è–¦</h4>
                            </div>
                            <i data-lucide="chevron-right" class="text-gray-200"></i>
                        </div>
                    </div>
                </section>
            </div>
        `;

        const renderCalorie = () => {
            const total = state.calories.reduce((sum, item) => sum + item.cal, 0);
            return `
            <div class="space-y-6">
                <div class="bg-[#FFCCF9] p-10 rounded-[3rem] text-center shadow-lg relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[#FF85A1] font-black text-xs tracking-widest uppercase mb-1">ä»Šæ—¥ç¾é£Ÿæ‰£æ‰“</p>
                        <div class="text-6xl font-black text-white">${total} <span class="text-xl">kcal</span></div>
                    </div>
                    <i data-lucide="flame" class="absolute -bottom-10 -left-10 w-48 h-48 text-white opacity-20"></i>
                </div>
                <div class="bg-white p-6 rounded-[2rem] border border-gray-50 space-y-4">
                    <div class="flex flex-col sm:flex-row gap-2.5">
                        <input id="food-name" class="flex-1 bg-gray-50 p-4 rounded-xl text-sm" placeholder="åƒäº†ä»€éº¼ï¼Ÿ">
                        <input id="food-cal" class="sm:w-24 bg-gray-50 p-4 rounded-xl text-sm" placeholder="Kcal" type="number">
                    </div>
                    <button onclick="addCalorie()" class="w-full bg-[#FF85A1] text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-all">è¨˜éŒ„ç¾å‘³ ğŸ˜‹</button>
                </div>
                <div class="space-y-2">
                    ${state.calories.map(item => `
                        <div class="bg-white/60 p-4 rounded-2xl flex justify-between items-center border border-white text-sm">
                            <span class="font-bold text-gray-600">${item.name}</span>
                            <span class="text-[#FF85A1] font-black">${item.cal} kcal</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        };

        const renderJournal = () => `
            <div class="space-y-6">
                <h3 class="text-2xl font-black text-[#FFA45B]">æ—…ç¨‹æ—¥è¨˜ ğŸ“–</h3>
                <div class="bg-white p-6 rounded-[2rem] shadow-sm space-y-4 border border-gray-50">
                    <textarea id="journal-content" class="w-full min-h-[150px] bg-transparent outline-none text-gray-600 placeholder:text-gray-300 resize-none font-medium" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼æœ‰è¶£çš„äº‹ï¼Ÿ"></textarea>
                    <button onclick="addJournal()" class="w-full bg-[#FFA45B] text-white font-black py-4 rounded-2xl shadow-lg">å„²å­˜å¿«æ¨‚ âœ¨</button>
                </div>
                <div class="space-y-3">
                    ${state.journals.sort((a,b) => b.time - a.time).map(entry => `
                        <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-50">
                            <p class="text-[10px] font-black text-gray-300 mb-2 uppercase tracking-tighter">${entry.date}</p>
                            <p class="text-gray-600 leading-relaxed font-medium">${entry.content}</p>
                        </div>
                    `).join('')}
                </div>
            </div>`;

        const renderItinerary = () => `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-black text-[#FFA45B]">è¡Œç¨‹ä¸­å¿ƒ ğŸ—ºï¸</h3>
                    <button onclick="addItinerary()" class="bg-[#FFA45B] text-white p-3 rounded-2xl shadow-lg"><i data-lucide="plus"></i></button>
                </div>
                <div class="space-y-3">
                    ${state.myItineraries.map(item => `
                        <div class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-4 border border-gray-50">
                            <div class="w-12 h-12 rounded-xl bg-gray-50 flex items-center justify-center text-xl">ğŸ“Œ</div>
                            <div class="flex-1">
                                <h4 class="font-black text-gray-700">${item.title}</h4>
                                <p class="text-[10px] text-gray-400 uppercase">${item.date}</p>
                            </div>
                            <i data-lucide="chevron-right" class="text-gray-200"></i>
                        </div>
                    `).join('')}
                </div>
            </div>`;

        const renderGuideDetail = () => `
            <div class="space-y-6 slide-up">
                <button onclick="state.selectedGuide=null; render()" class="flex items-center gap-2 text-gray-400 font-bold hover:text-[#FF85A1]"><i data-lucide="arrow-left"></i> è¿”å›</button>
                <div class="${state.selectedGuide.color} p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                    <h2 class="text-3xl font-black">${state.selectedGuide.title}</h2>
                    <div class="absolute top-4 right-4 text-7xl opacity-20 transform rotate-12">${state.selectedGuide.img}</div>
                </div>
                <div class="space-y-4">
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-50 flex items-center gap-4">
                        <div class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center text-white font-black">1</div>
                        <div class="flex-1 font-bold">ç†±é–€é¦–é¸æ¨è–¦</div>
                        <div class="text-[#FF85A1] font-black">9.9</div>
                    </div>
                </div>
            </div>`;

        // --- è¡Œç‚ºè™•ç† ---
        window.addCalorie = async () => {
            const name = document.getElementById('food-name').value;
            const cal = document.getElementById('food-cal').value;
            if (!name || !cal || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'calories'), { name, cal: parseInt(cal), time: Date.now() });
            document.getElementById('food-name').value = '';
            document.getElementById('food-cal').value = '';
        };

        window.addJournal = async () => {
            const content = document.getElementById('journal-content').value;
            if (!content || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals'), { content, date: new Date().toLocaleDateString(), time: Date.now() });
            document.getElementById('journal-content').value = '';
        };

        window.addItinerary = async () => {
            const title = prompt("è«‹è¼¸å…¥è¡Œç¨‹åç¨±ï¼š");
            if (!title || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries'), { title, date: new Date().toLocaleDateString() });
        };

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            initAuth();
            render();
        };

    </script>
</body>
</html>