<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è‰²ç­†è¨˜ Pro - æ——è‰¦å·”å³°æœ€çµ‚ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --palette-pink: #FF85A1;
            --palette-blue: #8EC5FC;
            --palette-orange: #FFA45B;
            --palette-purple: #E0C3FC;
            --palette-bg: #FFFDF0;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--palette-bg);
            color: #334155;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .float-btn { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(142, 197, 252, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(142, 197, 252, 0); }
            100% { box-shadow: 0 0 0 0 rgba(142, 197, 252, 0); }
        }

        .nav-active {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.15);
        }

        .folder-active {
            background-color: var(--palette-pink);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 133, 161, 0.3);
        }
    </style>
</head>
<body class="pb-36">

    <!-- æ¨™é¡Œè¦–è¦º -->
    <header class="pt-10 pb-6 text-center relative max-w-4xl mx-auto flex flex-col items-center px-4">
        <div class="relative inline-block">
            <h1 class="text-5xl md:text-6xl font-black text-[#FF85A1] tracking-tighter drop-shadow-sm italic">æ—…è‰²ç­†è¨˜</h1>
            <div class="absolute -right-4 -top-2 w-6 h-6 bg-[#FFD1A4] rounded-full opacity-60 animate-pulse"></div>
        </div>
        <p class="text-[10px] text-slate-400 font-bold tracking-[0.4em] mt-1 opacity-70 uppercase">Peak Pro Edition</p>
        
        <button class="absolute right-6 top-10 w-11 h-11 bg-white rounded-2xl shadow-md flex items-center justify-center text-[#FF85A1] border border-slate-100">
            <i data-lucide="user-round" class="w-5 h-5"></i>
        </button>
    </header>

    <main id="main-content" class="px-5 md:px-8 max-w-4xl mx-auto"></main>

    <!-- åœ°åœ–æ‡¸æµ®æ¨™ -->
    <button id="floating-map-btn" onclick="window.open('https://www.google.com/maps')" class="fixed bottom-28 right-6 w-14 h-14 bg-[#8EC5FC] text-white rounded-full shadow-2xl flex items-center justify-center z-40 border-4 border-white float-btn transition-transform active:scale-90 hidden">
        <i data-lucide="navigation" class="w-7 h-7" fill="currentColor"></i>
    </button>

    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[94%] max-w-lg glass rounded-[2.5rem] p-1.5 shadow-2xl flex justify-between items-center z-50">
        <button onclick="switchTab('home')" id="nav-home" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all flex-1 text-slate-400">
            <i data-lucide="compass" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">é¦–é </span>
        </button>
        <button onclick="switchTab('favorite')" id="nav-favorite" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all flex-1 text-slate-400">
            <i data-lucide="heart" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">æ”¶è—</span>
        </button>
        <button onclick="switchTab('itinerary')" id="nav-itinerary" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all flex-1 text-slate-400">
            <i data-lucide="map-pinned" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('calorie')" id="nav-calorie" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all flex-1 text-slate-400">
            <i data-lucide="flame" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">ç†±é‡</span>
        </button>
        <button onclick="switchTab('journal')" id="nav-journal" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all flex-1 text-slate-400">
            <i data-lucide="pen-tool" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">æ—¥è¨˜</span>
        </button>
        <button onclick="switchTab('checklist')" id="nav-checklist" class="nav-btn flex flex-col items-center justify-center p-2 rounded-2xl transition-all flex-1 text-slate-400">
            <i data-lucide="check-check" class="w-5 h-5"></i>
            <span class="text-[8px] md:text-[9px] mt-1 font-bold">æ¸…å–®</span>
        </button>
    </nav>

    <!-- å±¤ç´šåŒ–åœ°å€é¸å–æŠ½å±œ -->
    <div id="region-picker" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-end justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-t-[3rem] p-8 shadow-2xl translate-y-full transition-transform duration-500 overflow-hidden relative">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            
            <!-- æœå°‹åˆ— -->
            <div class="mb-4 relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                <input type="text" id="picker-search" oninput="handlePickerSearch(this.value)" class="w-full bg-slate-100 p-3 pl-11 rounded-2xl outline-none focus:ring-2 focus:ring-[#FF85A1]/20 font-bold text-sm" placeholder="å…¨åŸŸæœå°‹åŸå¸‚æˆ–åœ‹å®¶...">
            </div>

            <div id="picker-content" class="max-h-[50vh] overflow-y-auto no-scrollbar"></div>
            <button onclick="closePicker()" class="w-full mt-6 py-4 bg-slate-100 rounded-2xl font-bold text-slate-400 active:scale-95 transition-all">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'travel-palette-ultimate-pro';

        let currentUser = null;
        let activeTab = 'home';
        
        // å…¨åŸŸç‹€æ…‹æ›è¼‰åˆ° window ä»¥ä¾¿ HTML å­˜å–
        window.state = {
            calories: [],
            itineraries: [],
            journals: [],
            checklist: [],
            favorites: [],
            folders: ["é è¨­æ”¶è—"],
            activeFolder: "é è¨­æ”¶è—",
            activeItinTab: 'personal',
            activeRegion: 'æ±äº¬',
            selectedGuide: null,
            showAdventure: true,
            // é¸å–å™¨
            pickerStep: 'continent', 
            selectedContinent: null,
            selectedCountry: null,
            searchQuery: ''
        };

        // åœ°ç†èˆ‡æ’è¡Œæ•¸æ“šåº«
        const geoData = [
            { continent: "äºæ´²", icon: "ğŸŒ", countries: [
                { name: "æ—¥æœ¬", cities: ["æ±äº¬", "å¤§é˜ª", "äº¬éƒ½", "åŒ—æµ·é“", "æ²–ç¹©"] },
                { name: "å°ç£", cities: ["å°åŒ—", "å°ä¸­", "é«˜é›„", "å°å—", "èŠ±è“®"] },
                { name: "éŸ“åœ‹", cities: ["é¦–çˆ¾", "é‡œå±±", "æ¿Ÿå·å³¶"] }
            ]},
            { continent: "æ­æ´²", icon: "ğŸ°", countries: [
                { name: "è‹±åœ‹", cities: ["å€«æ•¦", "æ›¼å¾¹æ–¯ç‰¹"] },
                { name: "æ³•åœ‹", cities: ["å·´é»", "é‡Œæ˜‚"] },
                { name: "ç¾©å¤§åˆ©", cities: ["ç¾…é¦¬", "å¨å°¼æ–¯", "ç±³è˜­"] }
            ]},
            { continent: "ç¾æ´²", icon: "ğŸ—½", countries: [
                { name: "ç¾åœ‹", cities: ["ç´ç´„", "æ´›æ‰ç£¯", "æ‹‰æ–¯ç¶­åŠ æ–¯"] }
            ]}
        ];

        const rankingData = {
            "æ±äº¬": {
                spot: [{n:"æ·ºè‰å¯º", s:"4.9", d:"å¤è€å‚³çµ±èˆ‡ç¾ä»£äº¤ç¹”"}, {n:"æ±äº¬éµå¡”", s:"4.8", d:"æµªæ¼«åœ°æ¨™æ™¯è‰²çµ•ä½³"}, {n:"æ˜æ²»ç¥å®®", s:"4.7", d:"éƒ½å¸‚ä¸­çš„éœè¬æ£®æ—"}],
                food: [{n:"ç¯‰åœ°å ´å¤–å¸‚å ´", s:"4.9", d:"æµ·é®®æ„›å¥½è€…çš„å¤©å ‚"}, {n:"ä¸€è˜­æ‹‰éºµ", s:"4.8", d:"äº«è­½å…¨çƒçš„æ‹‰éºµé«”é©—"}, {n:"é˜¿å¤«åˆ©æŸšå­æ‹‰éºµ", s:"4.8", d:"æ¸…æ–°å£æ„Ÿç¨æ¨¹ä¸€å¹Ÿ"}]
            },
            "å°åŒ—": {
                spot: [{n:"å°åŒ— 101", s:"4.9", d:"ä¿¯ç°ç›†åœ°çš„éœ‡æ’¼æ™¯è‡´"}, {n:"åœ‹ç«‹æ•…å®®åšç‰©é™¢", s:"4.9", d:"æ­·å²æ–‡åŒ–çš„å¯¶åº«"}, {n:"è¥¿é–€ç”º", s:"4.7", d:"æ½®æµèˆ‡å‚³çµ±çš„ç¢°æ’"}],
                food: [{n:"é¼æ³°è±", s:"4.9", d:"é»ƒé‡‘ 18 æ‘ºå°ç± åŒ…"}, {n:"é¥’æ²³è¡—å¤œå¸‚", s:"4.8", d:"åœ¨åœ°å¤æ—©å‘³ç¾é£Ÿèšè½"}]
            },
            "å€«æ•¦": {
                spot: [{n:"å€«æ•¦çœ¼", s:"4.8", d:"å·¨å‹æ‘©å¤©è¼ªæ™¯ç·»"}, {n:"å¤§ç¬¨é˜", s:"4.9", d:"å‚³å¥‡çš„æ™‚é˜å¡”"}, {n:"å¤§è‹±åšç‰©é¤¨", s:"4.9", d:"å…¨äººç±»çš„æ–‡åŒ–é—äº§"}],
                food: [{n:"Poppies Fish & Chips", s:"4.6", d:"æœ€é“åœ°çš„è‹±å¼ç‚¸é­š"}, {n:"Borough Market", s:"4.8", d:"ç¾é£Ÿæ„›å¥½è€…çš„è–åœ°"}]
            }
        };

        const init = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error(e); }

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) setupListeners();
                render();
            });
        };

        const setupListeners = () => {
            if (!currentUser) return;
            const userRef = (col) => collection(db, 'artifacts', appId, 'users', currentUser.uid, col);
            const err = (e) => console.error(e);

            onSnapshot(userRef('calories'), s => { state.calories = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='calorie') render(); }, err);
            onSnapshot(userRef('journals'), s => { state.journals = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='journal') render(); }, err);
            onSnapshot(userRef('itineraries'), s => { state.itineraries = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='itinerary') render(); }, err);
            onSnapshot(userRef('checklist'), s => { state.checklist = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='checklist') render(); }, err);
            onSnapshot(userRef('favorites'), s => { state.favorites = s.docs.map(d => ({id:d.id, ...d.data()})); if(activeTab==='favorite' || activeTab==='home') render(); }, err);
            onSnapshot(userRef('folders'), s => { 
                const f = s.docs.map(d => d.data().name);
                state.folders = f.length > 0 ? f : ["é è¨­æ”¶è—"];
                if(activeTab==='favorite') render(); 
            }, err);
        };

        // --- è¦–åœ–ç®¡ç† ---
        window.switchTab = (tab) => { activeTab = tab; state.selectedGuide = null; render(); };
        window.render = () => {
            const main = document.getElementById('main-content');
            const mapBtn = document.getElementById('floating-map-btn');
            
            if (activeTab === 'home' && !state.selectedGuide) mapBtn.classList.remove('hidden');
            else mapBtn.classList.add('hidden');

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active', 'bg-[#8EC5FC]', 'bg-[#FF85A1]', 'bg-[#FFA45B]', 'bg-[#FFCCF9]', 'bg-[#FFD1A4]', 'bg-[#B2F9B4]', 'text-white', 'shadow-lg'));
            const activeBtn = document.getElementById(`nav-${activeTab}`);
            const themeColors = { home: 'bg-[#8EC5FC]', favorite: 'bg-[#FF85A1]', itinerary: 'bg-[#FFA45B]', calorie: 'bg-[#FFCCF9]', journal: 'bg-[#FFD1A4]', checklist: 'bg-[#B2F9B4]' };
            if (activeBtn) activeBtn.classList.add('nav-active', themeColors[activeTab], 'text-white', 'shadow-lg');

            if (state.selectedGuide) main.innerHTML = renderGuideDetail();
            else {
                switch(activeTab) {
                    case 'home': main.innerHTML = renderHome(); break;
                    case 'favorite': main.innerHTML = renderFavorite(); break;
                    case 'itinerary': main.innerHTML = renderItinerary(); break;
                    case 'calorie': main.innerHTML = renderCalorie(); break;
                    case 'journal': main.innerHTML = renderJournal(); break;
                    case 'checklist': main.innerHTML = renderChecklist(); break;
                }
            }
            lucide.createIcons();
        };

        // --- çµ„ä»¶æ¸²æŸ“å™¨ ---
        const renderHome = () => `
            <div class="space-y-8 fade-in">
                ${state.showAdventure ? `
                <div class="bg-gradient-to-br from-[#8EC5FC] to-[#E0C3FC] p-7 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden group">
                    <button onclick="window.state.showAdventure=false; render()" class="absolute top-4 right-4 p-1 hover:bg-white/20 rounded-full transition-colors z-20"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-black italic">æ¢ç´¢éˆæ„Ÿä¹‹æ—…</h2>
                        <p class="opacity-80 mt-1 mb-5 text-sm font-medium">æ”¶è—æ‚¨æœ€åš®å¾€çš„æ—…éŠé¢¨æ™¯</p>
                        <button onclick="window.open('https://www.google.com/maps')" class="bg-white text-[#8EC5FC] px-6 py-2.5 rounded-full font-bold flex items-center gap-2 shadow-lg active:scale-95 transition-all text-sm">
                            <i data-lucide="navigation" class="w-4 h-4" fill="currentColor"></i> é–‹å•Ÿåœ°åœ–
                        </button>
                    </div>
                    <i data-lucide="globe" class="absolute -bottom-6 -right-6 w-32 h-32 opacity-20 transform -rotate-12 group-hover:scale-110 transition-transform"></i>
                </div>` : ''}

                <section>
                    <div class="flex justify-between items-end mb-4 px-1">
                        <h3 class="text-xl font-black flex items-center gap-2"><div class="w-2 h-6 bg-[#FF85A1] rounded-full"></div>ä»Šæ—¥æ¨è–¦</h3>
                        <button onclick="openRegionPicker()" class="text-xs font-black text-[#FF85A1] flex items-center gap-1">æ›´æ›åŸå¸‚ <i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                    </div>
                    <div class="flex overflow-x-auto gap-4 pb-4 no-scrollbar -mx-5 px-5 snap-x">
                        ${[
                            {n:'äº¬éƒ½æ¸…æ°´å¯º', img:'https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400', t:'æ­·å²'},
                            {n:'å¤§é˜ªé“é “å €', img:'https://images.unsplash.com/photo-1590559899731-a382839e5549?w=400', t:'ç¾é£Ÿ'},
                            {n:'å¯Œå£«å±±æ²³å£æ¹–', img:'https://images.unsplash.com/photo-1490806678282-2d4d1877ee26?w=400', t:'æ™¯è§€'}
                        ].map(s => `
                            <div class="min-w-[200px] h-64 relative rounded-[2.5rem] overflow-hidden shadow-lg snap-start">
                                <img src="${s.img}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                                <button onclick="toggleFav('${s.n}', '${s.img}')" class="absolute top-4 right-4 p-2 bg-white/20 backdrop-blur-md rounded-full text-white active:scale-90 transition-all">
                                    <i data-lucide="heart" class="w-4 h-4" ${state.favorites.some(f=>f.name===s.n)?'fill="white"':''}></i>
                                </button>
                                <div class="absolute bottom-6 left-6 text-white">
                                    <span class="text-[9px] bg-white/20 backdrop-blur-md px-2 py-1 rounded-full uppercase font-bold border border-white/20">${s.t}</span>
                                    <p class="text-lg font-black mt-2">${s.n}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <section class="space-y-4">
                    <h3 class="text-xl font-black">æ¢ç´¢æ’è¡Œæ¦œ</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div onclick="openGuide({id:'spot', title:'äººæ°£æ™¯é»æ’è¡Œ', color:'bg-[#8EC5FC]', img:'ğŸ¯'})" class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-5 cursor-pointer hover:shadow-md border border-slate-50 active:scale-95 transition-all">
                            <div class="w-16 h-16 bg-[#8EC5FC] rounded-2xl flex items-center justify-center text-3xl shadow-inner">ğŸ¯</div>
                            <div class="flex-1"><span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">æ™¯é»</span><h4 class="font-black text-lg text-slate-700">ç†±é–€æ’è¡Œ</h4></div>
                            <i data-lucide="chevron-right" class="text-slate-200"></i>
                        </div>
                        <div onclick="openGuide({id:'food', title:'ç¾é£Ÿåœ°åœ–æ¨è–¦', color:'bg-[#FFCCF9]', img:'ğŸ£'})" class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-5 cursor-pointer hover:shadow-md border border-slate-50 active:scale-95 transition-all">
                            <div class="w-16 h-16 bg-[#FFCCF9] rounded-2xl flex items-center justify-center text-3xl shadow-inner">ğŸ£</div>
                            <div class="flex-1"><span class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">å¿…åƒ</span><h4 class="font-black text-lg text-slate-700">ç¾é£Ÿæ”»ç•¥</h4></div>
                            <i data-lucide="chevron-right" class="text-slate-200"></i>
                        </div>
                    </div>
                </section>
            </div>
        `;

        const renderGuideDetail = () => {
            const guide = state.selectedGuide;
            const data = rankingData[state.activeRegion] || {
                spot: [{n:`${state.activeRegion}æ¨è–¦æ™¯é»`, s:"9.8", d:"ç•¶åœ°çš„å¿…çœ‹åœ°æ¨™"}],
                food: [{n:`${state.activeRegion}åœ¨åœ°ç¾é£Ÿ`, s:"9.9", d:"ä¸å®¹éŒ¯éçš„é©šå–œæ»‹å‘³"}]
            };
            const items = guide.id === 'spot' ? data.spot : data.food;

            return `
                <div class="space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <button onclick="window.state.selectedGuide=null; render()" class="flex items-center gap-2 text-slate-400 font-bold hover:text-[#FF85A1]"><i data-lucide="arrow-left"></i> è¿”å›</button>
                        <button onclick="openRegionPicker()" class="px-4 py-2 bg-white border border-slate-100 rounded-full text-xs font-black text-[#FF85A1] shadow-sm flex items-center gap-1 active:scale-95 transition-all"><i data-lucide="map-pin" class="w-3 h-3"></i> ${state.activeRegion} (åˆ‡æ›)</button>
                    </div>
                    <div class="${guide.color} p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                        <h2 class="text-3xl font-black">${guide.title}</h2>
                        <div class="absolute top-4 right-4 text-7xl opacity-20 transform rotate-12">${guide.img}</div>
                    </div>
                    <div class="space-y-4">
                        ${items.map((it, idx) => `
                            <div class="bg-white p-6 rounded-[2.2rem] shadow-sm border border-slate-50 flex items-center gap-5 group">
                                <div class="w-12 h-12 ${idx===0?'bg-yellow-400':'bg-slate-100'} rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-inner">${idx+1}</div>
                                <div class="flex-1">
                                    <h4 class="font-black text-slate-700 text-lg">${it.n}</h4>
                                    <p class="text-xs text-slate-400 font-bold mt-1 uppercase tracking-wider">${it.d}</p>
                                    <div class="flex gap-2 mt-3">
                                        <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.n + ' ' + state.activeRegion)}')" class="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-500 hover:bg-[#8EC5FC] hover:text-white transition-all">å°èˆª</button>
                                        <button onclick="toggleFav('${it.n}', 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=400')" class="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-500 hover:bg-[#FF85A1] hover:text-white transition-all">æ”¶è—</button>
                                    </div>
                                </div>
                                <div class="text-[#FF85A1] font-black text-2xl">${it.s}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderFavorite = () => `
            <div class="space-y-6 fade-in">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-black text-[#FF85A1]">æˆ‘çš„æ”¶è— â¤ï¸</h3>
                    <div class="flex gap-2">
                        <button onclick="renameFolder()" class="bg-white border border-slate-100 text-slate-400 p-2.5 rounded-xl shadow-sm active:scale-90 transition-all"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                        <button onclick="addFolder()" class="bg-[#FF85A1] text-white p-2.5 rounded-xl shadow-md active:scale-90 transition-all"><i data-lucide="folder-plus" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <!-- åˆ†é¡æ©«åˆ— -->
                <div class="flex gap-3 overflow-x-auto no-scrollbar py-2">
                    ${state.folders.map(f => `
                        <div class="relative flex-shrink-0 group">
                            <button onclick="window.state.activeFolder='${f}'; render()" class="px-6 py-3 rounded-2xl font-black whitespace-nowrap text-sm transition-all ${state.activeFolder===f ? 'folder-active':'bg-white text-slate-400 border border-slate-100 hover:border-[#FF85A1]/30'}">${f}</button>
                            ${f !== "é è¨­æ”¶è—" ? `<button onclick="deleteFolder('${f}')" class="absolute -top-1 -right-1 bg-red-400 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    `).join('')}
                </div>

                <div class="grid grid-cols-2 gap-4">
                    ${state.favorites.filter(f=> (f.folder || "é è¨­æ”¶è—") === state.activeFolder).map(f => `
                        <div class="bg-white rounded-[2rem] overflow-hidden shadow-sm border border-slate-50 relative group fade-in">
                            <img src="${f.img}" class="w-full h-36 object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="p-4 bg-white relative z-10">
                                <h4 class="font-black text-slate-700 text-sm truncate">${f.name}</h4>
                                <div class="flex justify-between items-center mt-2">
                                    <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(f.name)}')" class="text-[10px] font-bold text-[#8EC5FC]">å°èˆª</button>
                                    <button onclick="deleteDocById('favorites', '${f.id}')" class="text-slate-300 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>
                    `).join('') || `<div class="col-span-2 py-20 text-center text-slate-300 font-bold italic">è©²åˆ†å€å°šç„¡æ”¶è—</div>`}
                </div>
            </div>
        `;

        const renderItinerary = () => `
            <div class="space-y-6 fade-in">
                <div class="flex justify-between items-center"><h3 class="text-2xl font-black text-[#FFA45B]">è¡Œç¨‹ä¸­å¿ƒ ğŸ—ºï¸</h3><button onclick="addItin()" class="w-12 h-12 bg-[#FFA45B] text-white rounded-2xl shadow-lg flex items-center justify-center active:scale-90 transition-all"><i data-lucide="plus"></i></button></div>
                <div class="bg-white p-1.5 rounded-[1.8rem] flex shadow-inner border border-slate-100">
                    <button onclick="window.state.activeItinTab='personal'; render()" class="flex-1 py-3 rounded-[1.5rem] font-black text-sm flex items-center justify-center gap-2 transition-all ${state.activeItinTab==='personal'?'bg-[#FFA45B] text-white shadow-md':'text-slate-400'}"><i data-lucide="user"></i> å€‹äºº</button>
                    <button onclick="window.state.activeItinTab='shared'; render()" class="flex-1 py-3 rounded-[1.5rem] font-black text-sm flex items-center justify-center gap-2 transition-all ${state.activeItinTab==='shared'?'bg-[#FF85A1] text-white shadow-md':'text-slate-400'}"><i data-lucide="users"></i> å…±äº«</button>
                </div>
                <div class="space-y-4">
                    ${state.itineraries.filter(i => (i.type || 'personal') === state.activeItinTab).map(i => `
                        <div class="bg-white p-5 rounded-[2.2rem] shadow-sm flex items-center gap-5 border border-slate-50 scale-in">
                            <div class="w-14 h-14 rounded-2xl bg-slate-50 flex items-center justify-center text-2xl">${state.activeItinTab==='personal'?'ğŸ“Œ':'ğŸ¤'}</div>
                            <div class="flex-1"><h4 class="font-black text-slate-700 text-lg">${i.title}</h4><p class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-tighter">${i.date}</p></div>
                            <button onclick="deleteDocById('itineraries', '${i.id}')" class="text-slate-200 hover:text-red-400 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    `).join('') || `<p class="py-20 text-center text-slate-300 font-bold italic">ç›®å‰ç©ºç©ºå¦‚ä¹Ÿ</p>`}
                </div>
            </div>
        `;

        const renderCalorie = () => {
            const total = state.calories.reduce((sum, i) => sum + i.cal, 0);
            return `
            <div class="space-y-6 fade-in">
                <div class="bg-[#FFCCF9] p-10 rounded-[3rem] text-center shadow-xl relative overflow-hidden"><div class="relative z-10"><p class="text-[#FF85A1] font-black text-xs tracking-widest uppercase mb-1">ä»Šæ—¥ç¾é£Ÿé ç®—</p><div class="text-6xl font-black text-white drop-shadow-md">${total} <span class="text-xl">kcal</span></div></div><i data-lucide="flame" class="absolute -bottom-10 -left-10 w-48 h-48 text-white opacity-25"></i></div>
                <div class="bg-white p-7 rounded-[2.5rem] space-y-4 shadow-sm border border-slate-50"><div class="flex flex-col sm:flex-row gap-3"><input id="cal-name" class="flex-1 bg-slate-50 p-4 rounded-2xl text-sm border-2 border-transparent focus:border-[#FFCCF9]/50 outline-none" placeholder="åƒäº†ä»€éº¼ï¼Ÿ"><input id="cal-val" class="sm:w-28 bg-slate-50 p-4 rounded-2xl text-sm border-2 border-transparent focus:border-[#FFCCF9]/50 outline-none" placeholder="kcal" type="number"></div><button onclick="addCal()" class="w-full bg-[#FF85A1] text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">è¨˜éŒ„ç¾å‘³ ğŸ±</button></div>
                <div class="space-y-3">${state.calories.map(c => `<div class="bg-white/80 p-4 rounded-2xl flex justify-between items-center border border-white shadow-sm scale-in"><span class="font-bold text-slate-600">${c.name}</span><div class="flex items-center gap-4"><span class="text-[#FF85A1] font-black">${c.cal} kcal</span><button onclick="deleteDocById('calories', '${c.id}')" class="text-slate-300 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button></div></div>`).join('')}</div>
            </div>`;
        };

        const renderJournal = () => `
            <div class="space-y-6 fade-in">
                <h3 class="text-2xl font-black text-[#FFD1A4]">å¿ƒæƒ…æ—¥è¨˜ âœï¸</h3>
                <div class="bg-white p-6 rounded-[2.5rem] space-y-4 border border-slate-50 shadow-sm"><textarea id="jou-text" class="w-full min-h-[160px] bg-slate-50 p-5 rounded-3xl outline-none text-slate-600 border-2 border-transparent focus:border-[#FFD1A4]/50" placeholder="é€™æ®µæ—…ç¨‹æœ‰ä»€éº¼æ·±åˆ»çš„å›æ†¶ï¼Ÿ"></textarea><button onclick="addJou()" class="w-full bg-[#FFD1A4] text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">å°å­˜ä»Šæ—¥ âœ¨</button></div>
                <div class="space-y-4">${state.journals.sort((a,b) => b.time - a.time).map(j => `<div class="bg-white p-6 rounded-[2.5rem] shadow-sm relative group border border-slate-50"><div class="flex justify-between items-center mb-3"><p class="text-[10px] font-black text-slate-300 uppercase tracking-widest">${j.date}</p><button onclick="deleteDocById('journals', '${j.id}')" class="text-slate-200 hover:text-red-400"><i data-lucide="trash" class="w-4 h-4"></i></button></div><p class="text-slate-600 text-sm leading-relaxed font-medium">${j.content}</p></div>`).join('')}</div>
            </div>`;

        const renderChecklist = () => `
            <div class="space-y-6 fade-in">
                <h3 class="text-2xl font-black text-[#56D8D0]">è¡Œææ¸…å–® âœ…</h3>
                <div class="bg-white p-5 rounded-[2.2rem] shadow-sm flex gap-3 border border-slate-50"><input id="check-item" class="flex-1 bg-slate-50 p-4 rounded-2xl text-sm outline-none border-2 border-transparent focus:border-[#56D8D0]/50" placeholder="æº–å‚™å¸¶ä»€éº¼ï¼Ÿ"><button onclick="addCheck()" class="w-14 h-14 bg-[#56D8D0] text-white rounded-2xl flex items-center justify-center active:scale-90 transition-all shadow-md"><i data-lucide="plus"></i></button></div>
                <div class="space-y-3">${state.checklist.map(i => `<div class="bg-white p-5 rounded-3xl flex items-center gap-4 shadow-sm border border-slate-50 ${i.done ? 'opacity-50' : ''}"><button onclick="toggleCheck('${i.id}', ${i.done})" class="w-7 h-7 rounded-full border-2 border-[#56D8D0] flex items-center justify-center ${i.done ? 'bg-[#56D8D0] text-white' : ''}">${i.done ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}</button><span class="flex-1 font-bold ${i.done ? 'line-through text-slate-400' : 'text-slate-600'}">${i.item}</span><button onclick="deleteDocById('checklist', '${i.id}')" class="text-slate-200 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('')}</div>
            </div>`;

        // --- åŠŸèƒ½å‡½æ•¸åº« ---
        window.openGuide = (g) => { state.selectedGuide = g; render(); };
        
        // æ”¶è—è³‡æ–™å¤¾ç®¡ç†
        window.addFolder = async () => {
            const n = prompt("è¼¸å…¥æ–°è³‡æ–™å¤¾åç¨±ï¼š");
            if (n && !state.folders.includes(n)) {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'folders'), { name: n, time: Date.now() });
                state.activeFolder = n;
            }
        };
        window.renameFolder = async () => {
            if (state.activeFolder === "é è¨­æ”¶è—") { alert("é è¨­è³‡æ–™å¤¾ç„¡æ³•é‡æ–°å‘½å"); return; }
            const n = prompt("è«‹è¼¸å…¥æ–°åç¨±ï¼š", state.activeFolder);
            if (n && n !== state.activeFolder) {
                // æ›´æ–°è³‡æ–™å¤¾åç¨±éœ€è¼ƒå¤šæ­¥é©Ÿï¼Œæ­¤è™•ç°¡åŒ–ç‚ºæ›´æ–°æ¨™ç±¤é‚è¼¯
                const s = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'folders');
                // åŸºæ–¼ç¾æœ‰ UI é‚è¼¯ç›´æ¥ä¿®æ”¹æœ¬åœ°å¾Œç”± Snapshot æ›´æ–°æœƒæ›´ç©©
                alert("é–‹ç™¼ä¸­ï¼šå»ºè­°åˆªé™¤å¾Œé‡æ–°å»ºç«‹");
            }
        };
        window.deleteFolder = async (name) => {
            if (name === "é è¨­æ”¶è—") return;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€è³‡æ–™å¤¾å—ï¼Ÿæ”¶è—çš„å…§å®¹å°‡ä¸€ä½µæ¶ˆå¤±ã€‚`)) return;
            // æ‰¾å‡º ID ä¸¦åˆªé™¤
            onSnapshot(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'folders'), s => {
                const docId = s.docs.find(d => d.data().name === name)?.id;
                if (docId) deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'folders', docId));
            });
            state.activeFolder = "é è¨­æ”¶è—";
            render();
        };

        window.addCal = async () => {
            const n = document.getElementById('cal-name').value; const v = document.getElementById('cal-val').value;
            if(!n || !v || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'calories'), { name:n, cal:parseInt(v), time:Date.now() });
            document.getElementById('cal-name').value = ''; document.getElementById('cal-val').value = '';
        };
        window.addJou = async () => {
            const t = document.getElementById('jou-text').value; if(!t || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journals'), { content:t, date:new Date().toLocaleDateString(), time:Date.now() });
            document.getElementById('jou-text').value = '';
        };
        window.addItin = async () => {
            const t = prompt("è¡Œç¨‹æ¨™é¡Œï¼š"); if(!t || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'itineraries'), { title:t, type:state.activeItinTab, date:new Date().toLocaleDateString(), time:Date.now() });
        };
        window.addCheck = async () => {
            const i = document.getElementById('check-item').value; if(!i || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'checklist'), { item:i, done:false, time:Date.now() });
            document.getElementById('check-item').value = '';
        };
        window.toggleCheck = async (id, s) => { await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'checklist', id), { done: !s }); };
        
        window.toggleFav = async (n, img) => {
            if(!currentUser) return; 
            const ex = state.favorites.find(f => f.name === n);
            if(ex) { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'favorites', ex.id)); }
            else { 
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'favorites'), { 
                    name: n, 
                    img, 
                    folder: state.activeFolder, 
                    time: Date.now() 
                }); 
            }
        };
        window.deleteDocById = async (col, id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, col, id)); };

        // --- åœ°å€é¸å–å™¨æ ¸å¿ƒé‚è¼¯ ---
        window.openRegionPicker = () => {
            const m = document.getElementById('region-picker');
            const d = m.querySelector('div');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.add('opacity-100'); d.classList.remove('translate-y-full'); }, 10);
            state.pickerStep = 'continent';
            state.searchQuery = '';
            document.getElementById('picker-search').value = '';
            renderPickerContent();
        };
        window.closePicker = () => {
            const m = document.getElementById('region-picker');
            const d = m.querySelector('div');
            m.classList.remove('opacity-100'); d.classList.add('translate-y-full');
            setTimeout(() => m.classList.add('hidden'), 500);
        };
        window.handlePickerSearch = (val) => {
            state.searchQuery = val.trim();
            state.pickerStep = state.searchQuery ? 'search' : 'continent';
            renderPickerContent();
        };
        window.selectContinent = (c) => { state.selectedContinent = c; state.pickerStep = 'country'; renderPickerContent(); };
        window.selectCountry = (c) => { state.selectedCountry = c; state.pickerStep = 'city'; renderPickerContent(); };
        window.selectCity = (c) => { state.activeRegion = c; closePicker(); render(); };

        const renderPickerContent = () => {
            const container = document.getElementById('picker-content');
            let html = "";
            if (state.pickerStep === 'search') {
                const results = [];
                geoData.forEach(cont => cont.countries.forEach(count => count.cities.forEach(city => {
                    if (city.includes(state.searchQuery) || count.name.includes(state.searchQuery)) results.push({ city, country: count.name, icon: cont.icon });
                })));
                html = `<div class="space-y-2">${results.map(r => `<button onclick="selectCity('${r.city}')" class="w-full bg-slate-50 p-4 rounded-2xl flex items-center justify-between hover:bg-[#FF85A1]/10 transition-all"><span class="font-bold text-slate-600">${r.icon} ${r.city}</span><span class="text-[10px] text-slate-400 font-black">${r.country}</span></button>`).join('') || '<p class="py-10 text-center text-slate-300">æŸ¥ç„¡åŸå¸‚</p>'}</div>`;
            } else if (state.pickerStep === 'continent') {
                html = `<div class="grid grid-cols-2 gap-4">${geoData.map(c => `<button onclick="selectContinent('${c.continent}')" class="bg-slate-50 p-6 rounded-3xl flex flex-col items-center gap-3 border-2 border-transparent hover:border-[#FF85A1]/30 transition-all"><span class="text-4xl">${c.icon}</span><span class="font-black text-slate-600 text-sm tracking-widest">${c.continent}</span></button>`).join('')}</div>`;
            } else if (state.pickerStep === 'country') {
                const countries = geoData.find(d => d.continent === state.selectedContinent).countries;
                html = `<div class="space-y-2"><button onclick="state.pickerStep='continent'; renderPickerContent()" class="text-xs font-black text-[#FF85A1] mb-3 px-2 flex items-center gap-1"><i data-lucide="chevron-left" class="w-3 h-3"></i> è¿”å›</button>${countries.map(c => `<button onclick="selectCountry('${c.name}')" class="w-full bg-slate-50 p-5 rounded-2xl flex items-center justify-between font-black text-slate-600 hover:bg-slate-100"><span>${c.name}</span><i data-lucide="chevron-right" class="w-4 h-4"></i></button>`).join('')}</div>`;
            } else if (state.pickerStep === 'city') {
                const cities = geoData.find(d => d.continent === state.selectedContinent).countries.find(c => c.name === state.selectedCountry).cities;
                html = `<div class="space-y-2"><button onclick="state.pickerStep='country'; renderPickerContent()" class="text-xs font-black text-[#FF85A1] mb-3 px-2 flex items-center gap-1"><i data-lucide="chevron-left" class="w-3 h-3"></i> è¿”å›</button><div class="grid grid-cols-2 gap-3">${cities.map(c => `<button onclick="selectCity('${c}')" class="bg-[#FF85A1]/5 border-2 border-[#FF85A1]/10 p-5 rounded-3xl font-black text-[#FF85A1] text-sm active:scale-95 transition-all">${c}</button>`).join('')}</div></div>`;
            }
            container.innerHTML = html;
            lucide.createIcons();
        };

        window.onload = init;
    </script>
</body>
</html>